{% extends "base.html" %}

{% block title %}Checkout{% endblock %}

{% block content %}
<div class="container">
    <div class="row mb-4">
        <div class="col">
            <h2>Checkout</h2>
        </div>
    </div>
    
    <div class="row">
        <div class="col-md-8">
            <!-- Shipping Address -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">Delivery Address</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <div class="d-flex align-items-center">
                            <i class="bi bi-geo-alt text-primary me-2"></i>
                            <div id="shippingAddressDisplay">
                                <div class="spinner-border spinner-border-sm text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <button class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#addressModal">
                        Change Address
                    </button>
                </div>
            </div>

            <!-- Order Items -->
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Order Items</h5>
                </div>
                <div class="card-body">
                    <div id="orderItems">
                        <!-- Order items will be populated by JavaScript -->
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-4">
            <!-- Order Summary -->
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Order Summary</h5>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between mb-2">
                        <span>Subtotal:</span>
                        <span class="subtotal">৳0</span>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span>Shipping Fee:</span>
                        <span class="shipping-fee">৳0</span>
                    </div>
                    <div class="d-flex justify-content-between mb-3">
                        <span>Tax (10%):</span>
                        <span class="tax">৳0</span>
                    </div>
                    
                    <div class="d-flex justify-content-between border-top pt-2">
                        <strong>Total:</strong>
                        <strong class="total">৳0</strong>
                    </div>

                    <div class="form-group mt-3">
                        <label for="instructions">Special Instructions</label>
                        <textarea class="form-control" id="instructions" rows="3" 
                                  placeholder="Add any special delivery instructions here"></textarea>
                    </div>
                    
                    <div class="d-grid gap-2 mt-4">
                        <button class="btn btn-primary" id="placeOrderBtn" disabled>
                            PLACE ORDER
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Address Modal -->
<div class="modal fade" id="addressModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Select Delivery Address</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addressForm">
                    <div class="mb-3">
                        <label class="form-label">Street Address</label>
                        <input type="text" class="form-control" id="street" required>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">City</label>
                            <input type="text" class="form-control" id="city" required>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">State</label>
                            <input type="text" class="form-control" id="state" required>
                        </div>
                        <div class="col-md-2 mb-3">
                            <label class="form-label">ZIP</label>
                            <input type="text" class="form-control" id="zipCode" required>
                        </div>
                    </div>
                    <input type="hidden" id="addressLat">
                    <input type="hidden" id="addressLng">
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveAddress">Save Address</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://maps.googleapis.com/maps/api/js?key={{ config.GOOGLE_MAPS_API_KEY }}&libraries=places"></script>
<script>
function formatPrice(price) {
    return '৳' + parseFloat(price).toFixed(2);
}

function loadShippingAddress() {
    fetch('/api/cart/shipping-address')
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success' && data.address) {
                document.getElementById('shippingAddressDisplay').innerHTML = `
                    <strong>${data.address}</strong>
                `;
                document.getElementById('placeOrderBtn').disabled = false;
            } else {
                document.getElementById('shippingAddressDisplay').innerHTML = `
                    <span class="text-danger">Please select a delivery address</span>
                `;
                document.getElementById('placeOrderBtn').disabled = true;
            }
        })
        .catch(error => {
            console.error('Error:', error);
            document.getElementById('shippingAddressDisplay').innerHTML = `
                <span class="text-danger">Error loading address</span>
            `;
        });
}

function updateOrderSummary() {
    fetch('/api/cart/items')
        .then(response => response.json())
        .then(data => {
            const orderItems = document.getElementById('orderItems');
            const subtotalEl = document.querySelector('.subtotal');
            const shippingFeeEl = document.querySelector('.shipping-fee');
            const taxEl = document.querySelector('.tax');
            const totalEl = document.querySelector('.total');
            
            if (data.status === 'success' && data.items && data.items.length > 0) {
                // Group items by shop
                const shopItems = {};
                let subtotal = 0;
                
                data.items.forEach(item => {
                    if (!shopItems[item.shop_id]) {
                        shopItems[item.shop_id] = {
                            shop_name: item.shop_name,
                            items: []
                        };
                    }
                    shopItems[item.shop_id].items.push(item);
                    subtotal += item.subtotal;
                });

                let html = '';
                Object.entries(shopItems).forEach(([shopId, shop]) => {
                    html += `
                        <div class="shop-items mb-4">
                            <h6 class="mb-3">${shop.shop_name}</h6>
                    `;

                    shop.items.forEach(item => {
                        html += `
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <div>
                                    <h6 class="mb-0">${item.name}</h6>
                                    <small class="text-muted">${formatPrice(item.price)} × ${item.quantity}</small>
                                </div>
                                <span>${formatPrice(item.subtotal)}</span>
                            </div>
                        `;
                    });

                    html += '</div>';
                });

                const shippingFee = 5.00;
                const tax = subtotal * 0.10;
                const total = subtotal + shippingFee + tax;

                orderItems.innerHTML = html;
                subtotalEl.textContent = formatPrice(subtotal);
                shippingFeeEl.textContent = formatPrice(shippingFee);
                taxEl.textContent = formatPrice(tax);
                totalEl.textContent = formatPrice(total);
            } else {
                orderItems.innerHTML = '<p class="text-center text-muted">Your cart is empty</p>';
                subtotalEl.textContent = formatPrice(0);
                shippingFeeEl.textContent = formatPrice(0);
                taxEl.textContent = formatPrice(0);
                totalEl.textContent = formatPrice(0);
                document.getElementById('placeOrderBtn').disabled = true;
            }
        })
        .catch(error => {
            console.error('Error:', error);
            document.getElementById('orderItems').innerHTML = 
                '<div class="alert alert-danger">Error loading order items</div>';
        });
}

function initializeAddressForm() {
    const streetInput = document.getElementById('street');
    const autocomplete = new google.maps.places.Autocomplete(streetInput);
    
    autocomplete.addListener('place_changed', function() {
        const place = autocomplete.getPlace();
        if (!place.geometry) {
            alert('Please select a valid address from the dropdown');
            return;
        }
        
        document.getElementById('addressLat').value = place.geometry.location.lat();
        document.getElementById('addressLng').value = place.geometry.location.lng();
        
        for (const component of place.address_components) {
            const type = component.types[0];
            if (type === 'locality') {
                document.getElementById('city').value = component.long_name;
            } else if (type === 'administrative_area_level_1') {
                document.getElementById('state').value = component.short_name;
            } else if (type === 'postal_code') {
                document.getElementById('zipCode').value = component.long_name;
            }
        }
    });
}

document.getElementById('saveAddress').addEventListener('click', function() {
    const form = document.getElementById('addressForm');
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }
    
    const addressParts = [
        document.getElementById('street').value,
        document.getElementById('city').value,
        document.getElementById('state').value,
        document.getElementById('zipCode').value
    ];
    
    const lat = document.getElementById('addressLat').value;
    const lng = document.getElementById('addressLng').value;
    
    if (!lat || !lng) {
        alert('Please select a valid address from the suggestions');
        return;
    }
    
    fetch('/api/cart/shipping-address', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            address: addressParts.join(', '),
            lat: parseFloat(lat),
            lng: parseFloat(lng)
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            bootstrap.Modal.getInstance(document.getElementById('addressModal')).hide();
            loadShippingAddress();
        } else {
            alert(data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error saving address');
    });
});

document.getElementById('placeOrderBtn').addEventListener('click', function() {
    const button = this;
    const instructions = document.getElementById('instructions').value;
    
    // Show processing state
    button.disabled = true;
    const originalText = button.innerHTML;
    button.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Processing...';
    
    fetch('/api/cart/items')
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success' && data.items && data.items.length > 0) {
                // Get all item IDs as selected for checkout
                const selectedItems = data.items.map(item => item.id);
                
                return fetch('/api/checkout', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        selected_items: selectedItems,
                        special_instructions: instructions
                    })
                });
            } else {
                throw new Error('Your cart is empty');
            }
        })
        .then(response => response.json())
        .then(result => {
            if (result.status === 'success') {
                // Show success message
                Swal.fire({
                    icon: 'success',
                    title: 'Order Placed Successfully!',
                    text: 'You will be redirected to your order details.',
                    showConfirmButton: false,
                    timer: 2000,
                    timerProgressBar: true
                }).then(() => {
                    // Redirect to first order detail page
                    window.location.href = `/user/order_detail/${result.order_ids[0]}`;
                });
            } else {
                throw new Error(result.message || 'Failed to place order');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            // Reset button state
            button.disabled = false;
            button.innerHTML = originalText;
            
            // Show error message
            Swal.fire({
                icon: 'error',
                title: 'Oops...',
                text: error.message || 'Error placing order. Please try again.',
                confirmButtonColor: '#3085d6'
            });
        });
});

// Initialize checkout page
document.addEventListener('DOMContentLoaded', function() {
    initializeAddressForm();
    loadShippingAddress();
    updateOrderSummary();
});
</script>
{% endblock %}