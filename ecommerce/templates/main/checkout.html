{% extends "base.html" %}

{% block title %}Checkout{% endblock %}

{% block content %}
<div class="container">
    <div class="row mb-4">
        <div class="col">
            <h2>Checkout</h2>
        </div>
    </div>
    
    <div class="row">
        <div class="col-md-8">
            <!-- Shipping Address -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">Delivery Address</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <div class="d-flex align-items-center">
                            <i class="bi bi-geo-alt text-primary me-2"></i>
                            <div id="shippingAddressDisplay">
                                <div class="spinner-border spinner-border-sm text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <button class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#addressModal">
                        Change Address
                    </button>
                </div>
            </div>

            <!-- Order Items -->
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Order Items</h5>
                </div>
                <div class="card-body">
                    <div id="orderItems">
                        <!-- Order items will be populated by JavaScript -->
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-4">
            <!-- Order Summary -->
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Order Summary</h5>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between mb-2">
                        <span>Subtotal:</span>
                        <span class="subtotal">৳0</span>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span>Shipping Fee:</span>
                        <div>
                            <span class="shipping-fee">৳0</span>
                            <button class="btn btn-sm btn-link text-primary p-0 ms-2" 
                                    id="negotiateShippingBtn" style="display: none;">
                                Negotiate
                            </button>
                        </div>
                    </div>
                    <div class="d-flex justify-content-between mb-3">
                        <span>Tax (10%):</span>
                        <span class="tax">৳0</span>
                    </div>
                    
                    <div class="d-flex justify-content-between border-top pt-2">
                        <strong>Total:</strong>
                        <strong class="total">৳0</strong>
                    </div>

                    <div class="form-group mt-3">
                        <label for="instructions">Special Instructions</label>
                        <textarea class="form-control" id="instructions" rows="3" 
                                  placeholder="Add any special delivery instructions here"></textarea>
                    </div>
                    
                    <div class="d-grid gap-2 mt-4">
                        <button class="btn btn-primary" id="placeOrderBtn" disabled>
                            PLACE ORDER
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Address Modal -->
<div class="modal fade" id="addressModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Select Delivery Address</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addressForm">
                    <div class="mb-3">
                        <label class="form-label">Street Address</label>
                        <input type="text" class="form-control" id="street" required>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">City</label>
                            <input type="text" class="form-control" id="city" required>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">State</label>
                            <input type="text" class="form-control" id="state" required>
                        </div>
                        <div class="col-md-2 mb-3">
                            <label class="form-label">ZIP</label>
                            <input type="text" class="form-control" id="zipCode" required>
                        </div>
                    </div>
                    <input type="hidden" id="addressLat">
                    <input type="hidden" id="addressLng">
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveAddress">Save Address</button>
            </div>
        </div>
    </div>
</div>

<!-- Shipping Fee Negotiation Modal -->
<div class="modal fade" id="shippingNegotiationModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Negotiate Shipping Fee</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Current Shipping Fee: <span id="currentShippingFee">৳0</span></label>
                    <div class="input-group">
                        <span class="input-group-text">৳</span>
                        <input type="number" class="form-control" id="negotiatedShippingFee" 
                               step="0.01" min="0" placeholder="Enter your offer">
                    </div>
                    <div class="form-text" id="negotiationGuidance"></div>
                </div>
                <div class="list-group mt-3" id="negotiationMessages"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="submitShippingNegotiation">Submit Offer</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://maps.googleapis.com/maps/api/js?key={{ config.GOOGLE_MAPS_API_KEY }}&libraries=places"></script>
<script>
function formatPrice(price) {
    return '৳' + parseFloat(price).toFixed(2);
}

function loadShippingAddress() {
    fetch('/api/cart/shipping-address')
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success' && data.address) {
                document.getElementById('shippingAddressDisplay').innerHTML = `
                    <strong>${data.address}</strong>
                `;
                document.getElementById('placeOrderBtn').disabled = false;
                
                // Calculate shipping fee after address is set
                calculateShippingFee();
            } else {
                document.getElementById('shippingAddressDisplay').innerHTML = `
                    <span class="text-danger">Please select a delivery address</span>
                `;
                document.getElementById('placeOrderBtn').disabled = true;
            }
        })
        .catch(error => {
            console.error('Error:', error);
            document.getElementById('shippingAddressDisplay').innerHTML = `
                <span class="text-danger">Error loading address</span>
            `;
        });
}

function calculateShippingFee() {
    const lat = document.getElementById('addressLat').value;
    const lng = document.getElementById('addressLng').value;
    
    if (!lat || !lng) return;
    
    fetch('/api/calculate-shipping', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            lat: parseFloat(lat),
            lng: parseFloat(lng)
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            const shippingFee = data.shipping_fee;
            document.querySelector('.shipping-fee').textContent = formatPrice(shippingFee);
            document.getElementById('currentShippingFee').textContent = formatPrice(shippingFee);
            document.getElementById('negotiateShippingBtn').style.display = 'inline';
            updateOrderTotal();
        }
    })
    .catch(error => console.error('Error calculating shipping:', error));
}

function updateOrderSummary() {
    fetch('/api/cart/items')
        .then(response => response.json())
        .then(data => {
            const orderItems = document.getElementById('orderItems');
            const subtotalEl = document.querySelector('.subtotal');
            const taxEl = document.querySelector('.tax');
            
            if (data.status === 'success' && data.items && data.items.length > 0) {
                const shopItems = {};
                let subtotal = 0;
                
                data.items.forEach(item => {
                    if (!shopItems[item.shop_id]) {
                        shopItems[item.shop_id] = {
                            shop_name: item.shop_name,
                            items: []
                        };
                    }
                    shopItems[item.shop_id].items.push(item);
                    subtotal += item.subtotal;
                });

                let html = '';
                Object.entries(shopItems).forEach(([shopId, shop]) => {
                    html += `
                        <div class="shop-items mb-4">
                            <h6 class="mb-3">${shop.shop_name}</h6>
                    `;

                    shop.items.forEach(item => {
                        html += `
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <div>
                                    <h6 class="mb-0">${item.name}</h6>
                                    <small class="text-muted">${formatPrice(item.price)} × ${item.quantity}</small>
                                </div>
                                <span>${formatPrice(item.subtotal)}</span>
                            </div>
                        `;
                    });

                    html += '</div>';
                });

                const tax = subtotal * 0.10;
                
                orderItems.innerHTML = html;
                subtotalEl.textContent = formatPrice(subtotal);
                taxEl.textContent = formatPrice(tax);
                updateOrderTotal();
            } else {
                orderItems.innerHTML = '<p class="text-center text-muted">Your cart is empty</p>';
                subtotalEl.textContent = formatPrice(0);
                taxEl.textContent = formatPrice(0);
                document.getElementById('placeOrderBtn').disabled = true;
            }
        })
        .catch(error => {
            console.error('Error:', error);
            document.getElementById('orderItems').innerHTML = 
                '<div class="alert alert-danger">Error loading order items</div>';
        });
}

function updateOrderTotal() {
    const subtotal = parseFloat(document.querySelector('.subtotal').textContent.replace('৳', ''));
    const shippingFee = parseFloat(document.querySelector('.shipping-fee').textContent.replace('৳', ''));
    const tax = parseFloat(document.querySelector('.tax').textContent.replace('৳', ''));
    const total = subtotal + shippingFee + tax;
    document.querySelector('.total').textContent = formatPrice(total);
}

function initializeAddressForm() {
    const streetInput = document.getElementById('street');
    const autocomplete = new google.maps.places.Autocomplete(streetInput);
    
    autocomplete.addListener('place_changed', function() {
        const place = autocomplete.getPlace();
        if (!place.geometry) {
            alert('Please select a valid address from the dropdown');
            return;
        }
        
        document.getElementById('addressLat').value = place.geometry.location.lat();
        document.getElementById('addressLng').value = place.geometry.location.lng();
        
        for (const component of place.address_components) {
            const type = component.types[0];
            if (type === 'locality') {
                document.getElementById('city').value = component.long_name;
            } else if (type === 'administrative_area_level_1') {
                document.getElementById('state').value = component.short_name;
            } else if (type === 'postal_code') {
                document.getElementById('zipCode').value = component.long_name;
            }
        }
    });
}

document.getElementById('saveAddress').addEventListener('click', function() {
    const form = document.getElementById('addressForm');
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }
    
    const addressParts = [
        document.getElementById('street').value,
        document.getElementById('city').value,
        document.getElementById('state').value,
        document.getElementById('zipCode').value
    ];
    
    const lat = document.getElementById('addressLat').value;
    const lng = document.getElementById('addressLng').value;
    
    if (!lat || !lng) {
        alert('Please select a valid address from the suggestions');
        return;
    }
    
    fetch('/api/cart/shipping-address', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            address: addressParts.join(', '),
            lat: parseFloat(lat),
            lng: parseFloat(lng)
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            bootstrap.Modal.getInstance(document.getElementById('addressModal')).hide();
            loadShippingAddress();
        } else {
            alert(data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error saving address');
    });
});

document.getElementById('negotiateShippingBtn').addEventListener('click', function() {
    const currentFee = parseFloat(document.querySelector('.shipping-fee').textContent.replace('৳', ''));
    document.getElementById('currentShippingFee').textContent = formatPrice(currentFee);
    document.getElementById('negotiatedShippingFee').value = '';
    document.getElementById('negotiationMessages').innerHTML = '';
    new bootstrap.Modal(document.getElementById('shippingNegotiationModal')).show();
});

document.getElementById('negotiatedShippingFee').addEventListener('input', function() {
    const currentFee = parseFloat(document.querySelector('.shipping-fee').textContent.replace('৳', ''));
    const offer = parseFloat(this.value);
    const guidance = document.getElementById('negotiationGuidance');
    
    if (isNaN(offer)) {
        guidance.textContent = '';
    } else if (offer >= currentFee) {
        guidance.textContent = 'Your offer should be lower than the current fee';
        guidance.className = 'form-text text-danger';
    } else if (offer < currentFee * 0.5) {
        guidance.textContent = 'Your offer might be too low to be accepted';
        guidance.className = 'form-text text-warning';
    } else {
        const discount = ((currentFee - offer) / currentFee * 100).toFixed(1);
        guidance.textContent = `You're requesting a ${discount}% discount`;
        guidance.className = 'form-text text-muted';
    }
});

document.getElementById('submitShippingNegotiation').addEventListener('click', function() {
    const offer = parseFloat(document.getElementById('negotiatedShippingFee').value);
    const messages = document.getElementById('negotiationMessages');
    
    if (isNaN(offer) || offer <= 0) {
        alert('Please enter a valid offer amount');
        return;
    }
    
    this.disabled = true;
    
    fetch('/api/negotiate-shipping', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            offer: offer
        })
    })
    .then(response => response.json())
    .then(data => {
        this.disabled = false;
        
        messages.innerHTML = `
            <div class="list-group-item">
                <strong>Your Offer:</strong> ${formatPrice(offer)}
            </div>
        `;
        
        if (data.status === 'success') {
            if (data.decision === 'accept') {
                messages.innerHTML += `
                    <div class="list-group-item bg-success text-white">
                        <strong>Accepted!</strong> New shipping fee: ${formatPrice(data.final_fee)}
                    </div>
                `;
                document.querySelector('.shipping-fee').textContent = formatPrice(data.final_fee);
                updateOrderTotal();
                setTimeout(() => {
                    bootstrap.Modal.getInstance(document.getElementById('shippingNegotiationModal')).hide();
                }, 2000);
            } else if (data.decision === 'counter') {
                messages.innerHTML += `
                    <div class="list-group-item bg-info text-white">
                        <strong>Counter Offer:</strong> ${formatPrice(data.counter_offer)}
                    </div>
                `;
            } else {
                messages.innerHTML += `
                    <div class="list-group-item bg-danger text-white">
                        <strong>Rejected:</strong> Offer too low
                    </div>
                `;
            }
        } else {
            messages.innerHTML += `
                <div class="list-group-item bg-danger text-white">
                    <strong>Error:</strong> ${data.message || 'Failed to process negotiation'}
                </div>
            `;
        }
    })
    .catch(error => {
        console.error('Error:', error);
        this.disabled = false;
        messages.innerHTML += `
            <div class="list-group-item bg-danger text-white">
                <strong>Error:</strong> Failed to process negotiation
            </div>
        `;
    });
});

document.getElementById('placeOrderBtn').addEventListener('click', function() {
    const button = this;
    const originalText = button.innerHTML;
    button.disabled = true;
    button.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Processing...';
    
    const instructions = document.getElementById('instructions').value;
    
    fetch('/api/place-order', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            special_instructions: instructions
        })
    })
    .then(response => response.json())
    .then(result => {
        if (result.status === 'success') {
            // Show success message
            Swal.fire({
                icon: 'success',
                title: 'Order Placed Successfully!',
                text: 'You will be redirected to your order details.',
                showConfirmButton: false,
                timer: 2000,
                timerProgressBar: true
            }).then(() => {
                // Redirect to first order detail page
                window.location.href = `/user/order_detail/${result.order_ids[0]}`;
            });
        } else {
            throw new Error(result.message || 'Failed to place order');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        // Reset button state
        button.disabled = false;
        button.innerHTML = originalText;
        
        // Show error message
        Swal.fire({
            icon: 'error',
            title: 'Oops...',
            text: error.message || 'Error placing order. Please try again.',
            confirmButtonColor: '#3085d6'
        });
    });
});

// Initialize checkout page
document.addEventListener('DOMContentLoaded', function() {
    initializeAddressForm();
    loadShippingAddress();
    updateOrderSummary();
});
</script>
{% endblock %}