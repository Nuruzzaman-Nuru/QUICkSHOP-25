{% extends "base.html" %}

{% block title %}My Negotiations{% endblock %}

{% block content %}
<div class="container py-4">
    <h2 class="mb-4">My Negotiations</h2>
    
    <div class="row">
        <div class="col-12">
            <!-- Filter options -->
            <div class="mb-4">
                <form method="GET" class="form-inline">
                    <div class="form-group mr-3">
                        <label for="sort" class="mr-2">Sort by:</label>
                        <select name="sort" id="sort" class="form-control" onchange="this.form.submit()">
                            <option value="newest" {% if request.args.get('sort') == 'newest' %}selected{% endif %}>Newest First</option>
                            <option value="highest_offer" {% if request.args.get('sort') == 'highest_offer' %}selected{% endif %}>Highest Offer</option>
                            <option value="lowest_offer" {% if request.args.get('sort') == 'lowest_offer' %}selected{% endif %}>Lowest Offer</option>
                        </select>
                    </div>
                </form>
            </div>

            <!-- Negotiations list -->
            {% for negotiation in negotiations %}
            <div class="card mb-3">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-8">
                            <h5 class="card-title">{{ negotiation.product.name }}</h5>
                            <p class="card-text">
                                <strong>Status:</strong> 
                                {% if negotiation.status == 'pending' %}
                                    <span class="badge badge-warning">Pending</span>
                                {% elif negotiation.status == 'counter_offer' %}
                                    <span class="badge badge-info">Counter Offer</span>
                                {% elif negotiation.status == 'accepted' %}
                                    <span class="badge badge-success">Accepted</span>
                                {% elif negotiation.status == 'rejected' %}
                                    <span class="badge badge-danger">Rejected</span>
                                {% endif %}
                            </p>
                            <div class="negotiation-details">
                                <p><strong>Original Price:</strong> ${{ "%.2f"|format(negotiation.initial_price) }}</p>
                                <p><strong>Your Offer:</strong> ${{ "%.2f"|format(negotiation.offered_price) }}</p>
                                {% if negotiation.counter_price %}
                                <p><strong>Counter Offer:</strong> ${{ "%.2f"|format(negotiation.counter_price) }}</p>
                                {% endif %}
                                {% if negotiation.final_price %}
                                <p><strong>Final Price:</strong> ${{ "%.2f"|format(negotiation.final_price) }}</p>
                                {% endif %}
                                <p><strong>Rounds:</strong> {{ negotiation.rounds }}</p>
                            </div>
                        </div>
                        <div class="col-md-4 text-right">
                            {% if negotiation.status in ['pending', 'counter_offer'] %}
                            <div class="counter-offer-form mb-3">                                <form class="form-inline justify-content-end" action="{{ url_for('api.negotiate_price', product_id=negotiation.product_id) }}" method="POST">
                                    <div class="form-group mx-2">
                                        <input type="number" step="0.01" min="0" class="form-control" name="offered_price" placeholder="Enter your offer" required>
                                    </div>
                                    <button type="submit" class="btn btn-primary">Make Counter Offer</button>
                                </form>
                            </div>
                            {% if negotiation.counter_price %}                            <form action="{{ url_for('api.accept_negotiation', negotiation_id=negotiation.id) }}" method="POST" class="d-inline">
                                <button type="submit" class="btn btn-success">Accept Counter Offer</button>
                            </form>
                            {% endif %}
                            {% endif %}
                            
                            <a href="{{ url_for('user.negotiation_detail', nego_id=negotiation.id) }}" class="btn btn-outline-secondary">View Details</a>
                        </div>
                    </div>
                </div>
            </div>
            {% else %}
            <div class="alert alert-info">
                You don't have any active negotiations.
            </div>
            {% endfor %}

            <!-- Pagination -->
            {% if pagination.pages > 1 %}
            <nav aria-label="Negotiations pagination">
                <ul class="pagination justify-content-center">
                    {% if pagination.has_prev %}
                    <li class="page-item">
                        <a class="page-link" href="{{ url_for('user.negotiations', page=pagination.prev_num, sort=request.args.get('sort', 'newest')) }}">Previous</a>
                    </li>
                    {% endif %}

                    {% for page_num in pagination.iter_pages(left_edge=2, left_current=2, right_current=3, right_edge=2) %}
                        {% if page_num %}
                            <li class="page-item {% if page_num == pagination.page %}active{% endif %}">
                                <a class="page-link" href="{{ url_for('user.negotiations', page=page_num, sort=request.args.get('sort', 'newest')) }}">{{ page_num }}</a>
                            </li>
                        {% else %}
                            <li class="page-item disabled"><span class="page-link">...</span></li>
                        {% endif %}
                    {% endfor %}

                    {% if pagination.has_next %}
                    <li class="page-item">
                        <a class="page-link" href="{{ url_for('user.negotiations', page=pagination.next_num, sort=request.args.get('sort', 'newest')) }}">Next</a>
                    </li>
                    {% endif %}
                </ul>
            </nav>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Handle counter offer form submissions
    document.querySelectorAll('.counter-offer-form form').forEach(form => {
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            const offeredPrice = parseFloat(this.querySelector('input[name="offered_price"]').value);
            const submitButton = this.querySelector('button[type="submit"]');
            
            submitButton.disabled = true;
            
            fetch(this.action, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    offered_price: offeredPrice
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    // Reload page to show updated negotiation
                    location.reload();
                } else {
                    alert(data.message || 'Error processing negotiation');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error processing negotiation');
            })
            .finally(() => {
                submitButton.disabled = false;
            });
        });
    });

    // Handle accept offer form submissions
    document.querySelectorAll('form[action*="accept_negotiation"]').forEach(form => {
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            const submitButton = this.querySelector('button[type="submit"]');
            
            submitButton.disabled = true;
            
            fetch(this.action, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    // Reload page to show updated negotiation
                    location.reload();
                } else {
                    alert(data.message || 'Error accepting negotiation');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error accepting negotiation');
            })
            .finally(() => {
                submitButton.disabled = false;
            });
        });
    });
});
</script>
{% endblock %}
