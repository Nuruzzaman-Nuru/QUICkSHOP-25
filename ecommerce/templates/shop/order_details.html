{% extends "base.html" %}

{% block title %}Order #{{ order.id }} Details{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Order #{{ order.id }}</h2>
        <div>
            {% if order.status == 'delivering' %}
                <a href="{{ url_for('user.track_order', order_id=order.id) }}" 
                   class="btn btn-info" target="_blank">
                    <i class="bi bi-geo-alt"></i> Track Delivery
                </a>
            {% endif %}
            <a href="{{ url_for('shop.orders') }}" class="btn btn-secondary">
                <i class="bi bi-arrow-left"></i> Back to Orders
            </a>
        </div>
    </div>

    <div class="row">
        <!-- Order Status and Info -->
        <div class="col-md-4">
            <div class="card mb-4">
                <div class="card-body">
                    <h5 class="card-title">Status</h5>
                    <div class="d-flex justify-content-between align-items-center">
                        <span class="badge bg-{{ {
                            'pending': 'warning',
                            'confirmed': 'info',
                            'delivering': 'primary',
                            'completed': 'success',
                            'cancelled': 'danger'
                        }[order.status] }} fs-6">
                            {{ order.status|title }}
                        </span>
                        <small class="text-muted">
                            Updated: {{ order.updated_at.strftime('%Y-%m-%d %H:%M') }}
                        </small>
                    </div>

                    {% if order.status == 'pending' %}
                        <div class="mt-3">
                            <button class="btn btn-success w-100 update-status"
                                    data-order-id="{{ order.id }}"
                                    data-status="confirmed">
                                <i class="bi bi-check-circle"></i> Confirm Order
                            </button>
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- Customer Information -->
            <div class="card mb-4">
                <div class="card-body">
                    <h5 class="card-title">Customer Information</h5>
                    <p class="mb-1"><strong>Name:</strong> {{ order.customer.username }}</p>
                    <p class="mb-1"><strong>Email:</strong> {{ order.customer.email }}</p>
                    <p class="mb-0"><strong>Contact:</strong> {{ order.customer.phone_number or 'Not provided' }}</p>
                </div>
            </div>

            <!-- Delivery Information -->
            <div class="card mb-4">
                <div class="card-body">
                    <h5 class="card-title">Delivery Information</h5>
                    {% if order.delivery_person %}
                        <p class="mb-1">
                            <strong>Delivery Person:</strong><br>
                            {{ order.delivery_person.username }}
                        </p>
                    {% endif %}
                    <p class="mb-1">
                        <strong>Delivery Address:</strong><br>
                        {{ order.delivery_address }}
                    </p>
                    {% if order.special_instructions %}
                        <div class="alert alert-warning mt-3 mb-0">
                            <strong>Special Instructions:</strong><br>
                            {{ order.special_instructions }}
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Order Items and Summary -->
        <div class="col-md-8">
            <div class="card mb-4">
                <div class="card-body">
                    <h5 class="card-title">Order Items</h5>
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Product</th>
                                    <th>Quantity</th>
                                    <th>Unit Price</th>
                                    <th>Negotiated Price</th>
                                    <th class="text-end">Subtotal</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in order.items %}
                                    <tr>
                                        <td>{{ item.product.name }}</td>
                                        <td>{{ item.quantity }}</td>
                                        <td>৳{{ "%.2f"|format(item.price) }}</td>
                                        <td>
                                            {% if item.negotiated_price %}
                                                ৳{{ "%.2f"|format(item.negotiated_price) }}
                                                <span class="badge bg-success">
                                                    -{{ "%.1f"|format((1 - item.negotiated_price/item.price) * 100) }}%
                                                </span>
                                            {% else %}
                                                -
                                            {% endif %}
                                        </td>
                                        <td class="text-end">৳{{ "%.2f"|format(item.subtotal) }}</td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                            <tfoot>
                                <tr>
                                    <td colspan="4" class="text-end">
                                        <strong>Items Total:</strong>
                                    </td>
                                    <td class="text-end">
                                        ৳{{ "%.2f"|format(order.total_amount) }}
                                    </td>
                                </tr>
                                <tr>
                                    <td colspan="4" class="text-end">
                                        <strong>Delivery Fee:</strong>
                                    </td>
                                    <td class="text-end">
                                        ৳{{ "%.2f"|format(order.delivery_fee) }}
                                    </td>
                                </tr>
                                <tr>
                                    <td colspan="4" class="text-end">
                                        <strong>Total Amount:</strong>
                                    </td>
                                    <td class="text-end">
                                        <strong>৳{{ "%.2f"|format(order.total_amount + order.delivery_fee) }}</strong>
                                    </td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Order Timeline -->
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Order Timeline</h5>
                    <div class="timeline">
                        <div class="timeline-item">
                            <div class="timeline-point bg-success"></div>
                            <div class="timeline-content">
                                <h6>Order Placed</h6>
                                <p class="text-muted mb-0">
                                    {{ order.created_at.strftime('%Y-%m-%d %H:%M') }}
                                </p>
                            </div>
                        </div>
                        {% if order.status != 'pending' %}
                            <div class="timeline-item">
                                <div class="timeline-point bg-info"></div>
                                <div class="timeline-content">
                                    <h6>Order Confirmed</h6>
                                    <p class="text-muted mb-0">
                                        Processing for delivery
                                    </p>
                                </div>
                            </div>
                        {% endif %}
                        {% if order.status == 'delivering' %}
                            <div class="timeline-item">
                                <div class="timeline-point bg-primary"></div>
                                <div class="timeline-content">
                                    <h6>Out for Delivery</h6>
                                    <p class="text-muted mb-0">
                                        Estimated delivery by {{ order.estimated_delivery_time.strftime('%I:%M %p') }}
                                    </p>
                                </div>
                            </div>
                        {% endif %}
                        {% if order.status == 'completed' %}
                            <div class="timeline-item">
                                <div class="timeline-point bg-success"></div>
                                <div class="timeline-content">
                                    <h6>Delivered</h6>
                                    <p class="text-muted mb-0">
                                        {{ order.updated_at.strftime('%Y-%m-%d %H:%M') }}
                                    </p>
                                </div>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Update Status Modal -->
<div class="modal fade" id="updateStatusModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Update Order Status</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to confirm this order? This will make it available for delivery.</p>
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i>
                    Once confirmed, delivery personnel in the area will be notified and can pick up the order.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" id="confirmStatusUpdate">
                    <i class="bi bi-check-circle"></i> Confirm Order
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block styles %}
<style>
.timeline {
    position: relative;
    padding: 20px 0;
}

.timeline-item {
    position: relative;
    padding-left: 40px;
    margin-bottom: 20px;
}

.timeline-point {
    position: absolute;
    left: 0;
    top: 0;
    width: 12px;
    height: 12px;
    border-radius: 50%;
}

.timeline-item:not(:last-child):before {
    content: '';
    position: absolute;
    left: 5px;
    top: 12px;
    bottom: -20px;
    width: 2px;
    background: #dee2e6;
}

.timeline-content {
    padding-bottom: 10px;
}
</style>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Handle status update button clicks
    document.querySelectorAll('.update-status').forEach(button => {
        button.addEventListener('click', function() {
            const orderId = this.dataset.orderId;
            const status = this.dataset.status;
            new bootstrap.Modal(document.getElementById('updateStatusModal')).show();
            
            // Set up confirmation button
            document.getElementById('confirmStatusUpdate').addEventListener('click', function handler() {
                this.removeEventListener('click', handler);
                updateOrderStatus(orderId, status);
            });
        });
    });
});

function updateOrderStatus(orderId, status) {
    const button = document.getElementById('confirmStatusUpdate');
    button.disabled = true;
    button.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Processing...';
    
    fetch(`/shop/order/${orderId}/update-status`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ status: status })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            location.reload();
        } else {
            alert(data.message || 'Error updating order status');
            button.disabled = false;
            button.innerHTML = '<i class="bi bi-check-circle"></i> Confirm Order';
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error updating order status');
        button.disabled = false;
        button.innerHTML = '<i class="bi bi-check-circle"></i> Confirm Order';
    });
}
</script>
{% endblock %}